'use @oigroup/lightscript with flippedImports'

import '@ormojo/ephraim': {
  entity, field, types
  declaredFields, declaredFieldKeys
  fieldKeys, flexFieldKeys, forEachField
  debug
}

{ makeConstructible } = debug


test! "fields by class", ->
  @entity() class E:
    @field() anyField

  @entity() class D extends E:
    @field(types.string) strField

  expect! E~declaredFields()['anyField']
    .toBeTruthy!

  expect! D~declaredFields()['strField']
    .toBeTruthy!

  expect! E~declaredFieldKeys()
    .toEqual(['anyField'])

  expect! D~declaredFieldKeys()
    .toEqual(['anyField', 'strField'])

  expect! D~declaredFields()['nope']
    .toBeFalsy!

test! "illegal field names", ->
  expect!
    ->
      @entity() class Bad1:
        @field() _underscored
    .toThrow("Field '_underscored' may not begin with '_' or contain '.'")
  // TODO: dotted example once class properties + decorators work right

test! "instance field metadata", ->
  @entity() class E:
    @field() anyField

  @entity() class D extends E:
    @field(types.string) strField

  CE = makeConstructible(E)
  CD = makeConstructible(D)

  e = new CE()
  d = new CD()
  d.flex = 1
  d._notFlex = 2
  d._veryNotFlex = -> 3

  d~forEachField((k, v, spec) -> console.log(k, v, spec))
  expect(e~declaredFields()).toBe(CE~declaredFields())
  expect(d~declaredFields()).toBe(CD~declaredFields())
  expect(e~fieldKeys()).toEqual(CE~declaredFieldKeys())
  expect(d~fieldKeys()).not.toEqual(CD~declaredFieldKeys())
  expect(d~flexFieldKeys()).toEqual(['flex'])




